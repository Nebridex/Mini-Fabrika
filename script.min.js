(function(){
  function qs(s,c){return (c||document).querySelector(s)}
  function qsa(s,c){return Array.from((c||document).querySelectorAll(s))}
  function escHtml(str){return String(str).replace(/[&<>'"]/g,function(m){return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];});}
  document.addEventListener('DOMContentLoaded',function(){
    var toggle=qs('.menu-toggle');
    var nav=qs('nav');
    if(toggle&&nav){
      toggle.addEventListener('click',function(){
        var open=nav.classList.toggle('open');
        toggle.setAttribute('aria-expanded',open?'true':'false');
      });
    }
    var params=new URLSearchParams(window.location.search);
    var sentBanner=qs('[data-sent-banner]');
    if(sentBanner&&params.get('sent')==='1'){sentBanner.hidden=false;}
    var modelName=params.get('model');
    var modelLink=params.get('link');
    var modelNameInput=qs('#modelAdi');
    var modelLinkInput=qs('#modelLink');
    var prefillBanner=qs('[data-prefill-banner]');
    if(modelName&&modelNameInput){modelNameInput.value=modelName;}
    if(modelLink&&modelLinkInput){modelLinkInput.value=modelLink;}
    if(prefillBanner&&(modelName||modelLink)){prefillBanner.hidden=false;}
    qsa('.qty-btn').forEach(function(btn){
      btn.addEventListener('click',function(){
        var input=qs('#adet');
        if(!input)return;
        var val=parseInt(input.value||'1',10);
        if(btn.dataset.qty==='plus'){input.value=val+1;}
        else{input.value=Math.max(1,val-1);}    
      });
    });
    qsa('form[data-formsubmit]').forEach(function(form){
      form.addEventListener('submit',function(e){
        var honey=qs('input[name="_honey"]',form);
        if(honey&&honey.value.trim()!==''){e.preventDefault();return;}
        var required=[
          {id:'adSoyad',msg:'Lütfen ad soyad girin.'},
          {id:'email',msg:'Lütfen e-posta adresi girin.'},
          {id:'modelLink',msg:'Lütfen model linkini girin.'},
          {id:'adet',msg:'Lütfen adet girin.'}
        ];
        for(var i=0;i<required.length;i++){
          var field=qs('#'+required[i].id,form);
          if(field&&!field.value.trim()){
            e.preventDefault();
            field.setCustomValidity(required[i].msg);
            field.reportValidity();
            return;
          }
          if(field){field.setCustomValidity('');}
        }
        var email=qs('#email',form);
        if(email&&!email.value.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)){
          e.preventDefault();
          email.setCustomValidity('Lütfen geçerli bir e-posta adresi girin.');
          email.reportValidity();
          return;
        }
        if(email){email.setCustomValidity('');}
        if(!form.checkValidity()){
          e.preventDefault();
          form.reportValidity();
        }
      });
    });
    var products=window.MINIFAB_PRODUCTS||null;
    var productsGrid=qs('#products-grid');
    if(products&&productsGrid){
      productsGrid.innerHTML=products.map(function(p){
        var teklif='teklif.html?model='+encodeURIComponent(p.title)+'&link='+encodeURIComponent(p.link);
        return '<article class="card product-card generated-card" data-category="'+escHtml(p.category)+'">'+
          (p.popular?'<span class="pop-badge">Popüler</span>':'')+
          '<a class="card-main-link" href="'+escHtml(p.link)+'" target="_blank" rel="noopener noreferrer">'+
          '<img class="topic-thumb" src="'+escHtml(p.img)+'" width="700" height="420" loading="lazy" decoding="async" alt="'+escHtml(p.title)+' 3D baskı örneği" />'+
          '<h2>'+escHtml(p.title)+'</h2></a>'+
          '<p>'+escHtml(p.description)+'</p>'+
          '<div class="meta-row"><span class="tag">'+escHtml(p.material)+'</span><span class="tag">'+escHtml(p.time)+'</span><span class="tag">'+escHtml(p.category)+'</span></div>'+
          '<a class="btn btn-secondary" href="'+escHtml(p.link)+'" target="_blank" rel="noopener noreferrer">MakerWorld\'de aç</a>'+
          '<a class="btn btn-primary" href="'+teklif+'">Bunu Bastır (Teklif Al)</a>'+
          '</article>';
      }).join('');
      qsa('.generated-card').forEach(function(card){
        card.addEventListener('click',function(e){
          if(e.target.closest('a')||e.target.closest('button')) return;
          var main=qs('.card-main-link',card);
          if(main){window.open(main.href,'_blank','noopener');}
        });
      });
    }
    var filterButtons=qsa('.filter-btn');
    if(filterButtons.length){
      filterButtons.forEach(function(btn){
        btn.addEventListener('click',function(){
          filterButtons.forEach(function(x){x.classList.remove('active')});
          btn.classList.add('active');
          var key=btn.getAttribute('data-filter');
          qsa('.product-card,.blog-card').forEach(function(card){
            var cat=card.getAttribute('data-category');
            card.style.display=(key==='all'||cat===key)?'block':'none';
          });
        });
      });
    }
    function firstField(selectors){
      for(var i=0;i<selectors.length;i++){
        var el=qs(selectors[i]);
        if(el) return el;
      }
      return null;
    }
    function setIfFound(selectors,value){
      if(value===undefined||value===null||value==='') return false;
      var el=firstField(selectors);
      if(!el) return false;
      el.value=String(value);
      return true;
    }
    function clean(v){
      return (v===undefined||v===null)?'':String(v).trim();
    }
    function getPath(obj,paths){
      for(var i=0;i<paths.length;i++){
        var parts=paths[i].split('.');
        var cur=obj;
        for(var j=0;j<parts.length;j++){
          if(!cur||cur[parts[j]]===undefined){cur=null;break;}
          cur=cur[parts[j]];
        }
        if(cur!==null&&cur!==undefined&&cur!=='') return cur;
      }
      return '';
    }
    function readLocalPayload(){
      try{
        var raw=localStorage.getItem('mf_teklif_payload');
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(_e){
        return null;
      }
    }
    function readQueryPayload(){
      var p=new URLSearchParams(window.location.search);
      if(!p.toString()) return null;
      if(p.get('payload')){
        try{return JSON.parse(p.get('payload'));}catch(_e){}
      }
      var out={};
      var x=p.get('x')||p.get('olcu_x');
      var y=p.get('y')||p.get('olcu_y');
      var z=p.get('z')||p.get('olcu_z');
      var gram=p.get('g')||p.get('gram');
      var sure=p.get('sure')||p.get('time');
      var sablon=p.get('tpl')||p.get('sablon')||p.get('template');
      var yazi=p.get('txt')||p.get('yazi')||p.get('text');
      var adet=p.get('adet')||p.get('quantity');
      var malzeme=p.get('malzeme')||p.get('material');
      var renk=p.get('renk')||p.get('color');
      var notlar=p.get('not')||p.get('notes');
      var ad=p.get('ad')||p.get('name');
      var tel=p.get('tel')||p.get('phone');
      var mail=p.get('mail')||p.get('email');
      if(x||y||z){out.olculer={x:x,y:y,z:z};}
      if(gram) out.gram=gram;
      if(sure) out.sure=sure;
      if(sablon) out.sablon=sablon;
      if(yazi) out.yazi=yazi;
      if(ad||tel||mail){out.kisi={ad:ad,tel:tel,mail:mail};}
      if(adet||malzeme||renk||notlar){out.istek={adet:adet,malzeme:malzeme,renk:renk,not:notlar};}
      return Object.keys(out).length?out:null;
    }
    function clearTransferFields(){
      [
        ['#fullName','[name="full_name"]','[name="ad"]','#adSoyad'],
        ['#phone','[name="phone"]','[name="telefon"]','#tel'],
        ['#email','[name="email"]','[name="mail"]'],
        ['#quantity','[name="quantity"]','#adet','[name="adet"]'],
        ['#material','[name="material"]','#malzeme','[name="malzeme"]'],
        ['#olcuX','[name="olcu_x"]','[name="olcuX"]'],
        ['#olcuY','[name="olcu_y"]','[name="olcuY"]'],
        ['#olcuZ','[name="olcu_z"]','[name="olcuZ"]'],
        ['#tahminiGram','[name="tahmini_gram"]','[name="gram"]'],
        ['#tahminiSure','[name="tahmini_sure"]','[name="sure"]'],
        ['#sablonAdi','[name="sablon_adi"]','[name="sablon"]'],
        ['#yazi','[name="yazi"]','[name="text"]'],
        ['#renk','[name="renk"]','[name="color"]'],
        ['#notes','[name="notes"]','[name="not"]','#aciklama']
      ].forEach(function(group){
        var el=firstField(group);
        if(!el) return;
        if(el.tagName==='SELECT'){el.selectedIndex=0;return;}
        if(el.type==='number'){el.value='1';return;}
        el.value='';
      });
      var banner=qs('[data-design-prefill-banner]');
      if(banner) banner.hidden=true;
      var stlBanner=qs('[data-stl-banner]');
      if(stlBanner){stlBanner.hidden=true;stlBanner.textContent='';}
      var stlBtn=qs('[data-stl-download]');
      if(stlBtn){
        if(stlBtn.dataset.blobUrl){
          URL.revokeObjectURL(stlBtn.dataset.blobUrl);
          delete stlBtn.dataset.blobUrl;
        }
        stlBtn.hidden=true;
        stlBtn.removeAttribute('href');
        stlBtn.removeAttribute('download');
      }
    }
    function prepareStlDownload(payload){
      var p=payload||{};
      var stl=p.stl||{};
      var stlBanner=qs('[data-stl-banner]');
      var stlBtn=qs('[data-stl-download]');
      if(!stlBtn&&!stlBanner) return;

      if(stlBtn&&stlBtn.dataset.blobUrl){
        URL.revokeObjectURL(stlBtn.dataset.blobUrl);
        delete stlBtn.dataset.blobUrl;
      }
      if(stlBtn){
        stlBtn.hidden=true;
        stlBtn.removeAttribute('href');
      }
      if(stlBanner){
        stlBanner.hidden=true;
        stlBanner.textContent='';
      }
      if(!stl||typeof stl!=='object') return;

      if(stl.tooLarge===true){
        if(stlBanner){
          stlBanner.textContent='Model dosyası büyük. Operasyon panelinden backend upload ile alın.';
          stlBanner.hidden=false;
        }
        return;
      }
      if(!stl.base64||!stlBtn) return;

      try{
        var stlText=decodeURIComponent(escape(atob(stl.base64)));
        var blob=new Blob([stlText],{type:stl.mime||'model/stl'});
        var blobUrl=URL.createObjectURL(blob);
        stlBtn.href=blobUrl;
        stlBtn.download=stl.filename||'model.stl';
        stlBtn.dataset.blobUrl=blobUrl;
        stlBtn.hidden=false;
        if(stlBanner){
          stlBanner.textContent='STL dosyası indirilmeye hazır.';
          stlBanner.hidden=false;
        }
      }catch(_e){
        if(stlBanner){
          stlBanner.textContent='STL dosyası hazırlanırken bir sorun oluştu.';
          stlBanner.hidden=false;
        }
      }
    }
    function fillTeklifFromPayload(payload){
      if(!payload) return;
      var olculer=payload.olculer||payload.olcu||payload.dimensions||{};
      var x=getPath(payload,['x','olcuX','olcu_x','size.x','dimensions.x'])||olculer.x;
      var y=getPath(payload,['y','olcuY','olcu_y','size.y','dimensions.y'])||olculer.y;
      var z=getPath(payload,['z','olcuZ','olcu_z','size.z','dimensions.z'])||olculer.z;
      var gram=getPath(payload,['gram','tahminiGram','estimate.gram','estimate.weight']);
      var sure=getPath(payload,['sure','tahminiSure','estimate.sure','estimate.time']);
      var sablon=getPath(payload,['sablonAdi','sablon','templateName','template']);
      var yazi=getPath(payload,['yazi','text','yaziIcerigi','customText']);
      var adet=getPath(payload,['adet','quantity','istek.adet']);
      var malzeme=getPath(payload,['malzeme','material','istek.malzeme']);
      var renk=getPath(payload,['renk','color','istek.renk']);
      var notlar=getPath(payload,['not','note','notes','istek.not']);
      var ad=getPath(payload,['ad','name','kisi.ad','person.name']);
      var tel=getPath(payload,['tel','phone','kisi.tel','person.phone']);
      var mail=getPath(payload,['mail','email','kisi.mail','person.email']);

      setIfFound(['#fullName','[name="full_name"]','[name="ad"]','#adSoyad'],ad);
      setIfFound(['#phone','[name="phone"]','[name="telefon"]','#tel'],tel);
      setIfFound(['#email','[name="email"]','[name="mail"]'],mail);
      setIfFound(['#quantity','[name="quantity"]','#adet','[name="adet"]'],adet);
      setIfFound(['#material','[name="material"]','#malzeme','[name="malzeme"]'],malzeme);
      setIfFound(['#olcuX','[name="olcu_x"]','[name="olcuX"]'],x);
      setIfFound(['#olcuY','[name="olcu_y"]','[name="olcuY"]'],y);
      setIfFound(['#olcuZ','[name="olcu_z"]','[name="olcuZ"]'],z);
      setIfFound(['#tahminiGram','[name="tahmini_gram"]','[name="gram"]'],gram);
      setIfFound(['#tahminiSure','[name="tahmini_sure"]','[name="sure"]'],sure);
      setIfFound(['#sablonAdi','[name="sablon_adi"]','[name="sablon"]'],sablon);
      setIfFound(['#yazi','[name="yazi"]','[name="text"]'],yazi);
      setIfFound(['#renk','[name="renk"]','[name="color"]'],renk);

      var notes=[];
      if(clean(x)||clean(y)||clean(z)) notes.push('Ölçüler (mm): '+clean(x)+' x '+clean(y)+' x '+clean(z));
      if(clean(gram)) notes.push('Tahmini Gram: '+clean(gram));
      if(clean(sure)) notes.push('Tahmini Süre: '+clean(sure));
      if(clean(sablon)) notes.push('Şablon Adı: '+clean(sablon));
      if(clean(yazi)) notes.push('Yazı: '+clean(yazi));
      if(clean(renk)) notes.push('Renk: '+clean(renk));
      if(clean(notlar)) notes.push('Not: '+clean(notlar));
      var noteField=firstField(['#notes','[name="notes"]','[name="not"]','#aciklama']);
      if(noteField&&notes.length){
        var existing=noteField.value||'';
        noteField.value=(existing?existing+'\n':'')+notes.join('\n');
      }
      var banner=qs('[data-design-prefill-banner]');
      if(banner) banner.hidden=false;

      prepareStlDownload(payload);
    }
    if(window.location.pathname.indexOf('teklif')!==-1){
      var payload=readLocalPayload();
      if(!payload){payload=readQueryPayload();}
      fillTeklifFromPayload(payload);

      var clearBtn=qs('[data-clear-teklif]');
      if(clearBtn){
        clearBtn.addEventListener('click',function(){
          try{localStorage.removeItem('mf_teklif_payload');}catch(_e){}
          clearTransferFields();
        });
      }
    }
    if(document.body.dataset.redirectHome==='true'){
      setTimeout(function(){window.location.href='index.html';},2000);
    }
  });
})();
