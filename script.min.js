(function(){
  function qs(s,c){return(c||document).querySelector(s)}
  function qsa(s,c){return Array.from((c||document).querySelectorAll(s))}

  function setupMenu(){
    var toggle=qs('.menu-toggle'), nav=qs('nav');
    if(!toggle||!nav)return;

    function syncMenuToggleVisibility(){
      var isMobile=window.matchMedia('(max-width: 900px)').matches;
      toggle.hidden=!isMobile;
      if(!isMobile){
        nav.classList.remove('open');
        toggle.setAttribute('aria-expanded','false');
      }
    }

    syncMenuToggleVisibility();
    window.addEventListener('resize',syncMenuToggleVisibility);

    toggle.addEventListener('click',function(){
      var open=nav.classList.toggle('open');
      toggle.setAttribute('aria-expanded',open?'true':'false');
    });
  }

  function setupFilters(){
    var buttons=qsa('.filter-btn');
    if(!buttons.length)return;
    var params=new URLSearchParams(location.search);
    var defaultCategory=params.get('category');
    var names={all:'Tümü',ofis:'Ofis',atolye:'Atölye',hediye:'Hediye',kurumsal:'Kurumsal',aksesuar:'Aksesuar',diger:'Diğer'};
    var heading=qs('[data-page-title-base]');

    function apply(key){
      buttons.forEach(function(b){b.classList.toggle('active',b.dataset.filter===key)});
      qsa('.product-card,.blog-card').forEach(function(card){
        card.style.display=(key==='all'||card.dataset.category===key)?'flex':'none';
      });
      if(key!=='all') params.set('category',key); else params.delete('category');
      history.replaceState(null,'',location.pathname+(params.toString()?('?'+params.toString()):''));
      if(heading) heading.textContent=(key==='all'?'İşlerimiz':'İşlerimiz — '+(names[key]||key));
    }

    buttons.forEach(function(btn){btn.addEventListener('click',function(){apply(btn.dataset.filter)})});
    if(defaultCategory&&buttons.some(function(b){return b.dataset.filter===defaultCategory;})) apply(defaultCategory);
  }

  function setupQuoteForm(){
    var form=qs('#quoteForm');
    if(!form)return;
    var params=new URLSearchParams(location.search);
    var modelName=params.get('modelName')||params.get('model');
    var modelUrl=params.get('modelUrl')||params.get('link');
    var category=params.get('category');
    var modelInput=qs('#modelLink');
    var notesInput=qs('#notes');
    var prefill=qs('[data-prefill-banner]');

    if(modelUrl&&modelInput) modelInput.value=modelUrl;
    if((modelName||category)&&notesInput){
      var n='';
      if(modelName) n+='Model: '+modelName+'\n';
      if(category) n+='Kategori: '+category+'\n';
      notesInput.value=(n+notesInput.value).trim();
    }
    if(prefill&&(modelName||modelUrl||category)) prefill.hidden=false;

    if(params.get('sent')==='1'){
      var success=qs('#formSuccess');
      if(success){
        success.textContent='Talebin alındı. E-posta kutunu kontrol et, ek bilgi gerekirse kısa sürede dönüş yapacağız.';
        success.hidden=false;
      }
    }

    form.addEventListener('submit',function(e){
      var email=qs('#email').value.trim();
      var phone=qs('#phone').value.replace(/\D/g,'');
      var quantity=qs('#quantity').value;
      var model=qs('#modelLink').value.trim();
      var warn=qs('#urlWarning'); if(warn) warn.hidden=true;

      if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){e.preventDefault();alert('Geçerli bir e-posta girin.');return;}
      if(phone && phone.length<10){e.preventDefault();alert('Telefon en az 10 haneli olmalı.');return;}
      if(!/^https?:\/\//i.test(model)){e.preventDefault();alert('Model linki geçerli bir URL olmalı.');return;}
      if(!/^\d+$/.test(quantity)||parseInt(quantity,10)<1){e.preventDefault();alert('Adet en az 1 olmalı.');return;}
      if(warn && !/(makerworld|printables|drive\.google)/i.test(model)) warn.hidden=false;

      var waLink=qs('#waLink');
      if(waLink){
        var body='Merhaba MiniFabrika,%0A%0ATeklif detaylarım:%0A'+
          'Ad Soyad: '+encodeURIComponent(qs('#fullName').value.trim())+'%0A'+
          'E-posta: '+encodeURIComponent(email)+'%0A'+
          'Telefon: '+encodeURIComponent(qs('#phone').value)+'%0A'+
          'Hizmet: '+encodeURIComponent(qs('#serviceType').value)+'%0A'+
          'Malzeme: '+encodeURIComponent(qs('#material').value)+'%0A'+
          'Adet: '+encodeURIComponent(quantity)+'%0A'+
          'Model Linki: '+encodeURIComponent(model)+'%0A'+
          'Notlar: '+encodeURIComponent(qs('#notes').value.trim());
        waLink.href='https://wa.me/905456900094?text='+decodeURIComponent(body);
      }
    });
  }

  document.addEventListener('DOMContentLoaded',function(){
    setupMenu();
    setupFilters();
    setupQuoteForm();
  });
})();
