(function(){
  function qs(s,c){return (c||document).querySelector(s)}
  function qsa(s,c){return Array.from((c||document).querySelectorAll(s))}

  function escHtml(str){return String(str).replace(/[&<>'"]/g,function(m){return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];});}

  document.addEventListener('DOMContentLoaded',function(){
    var toggle=qs('.menu-toggle');
    var nav=qs('nav');
    if(toggle&&nav){
      toggle.addEventListener('click',function(){
        var open=nav.classList.toggle('open');
        toggle.setAttribute('aria-expanded',open?'true':'false');
      });
    }

    qsa('a[href^="#"]').forEach(function(anchor){
      anchor.addEventListener('click',function(e){
        var id=anchor.getAttribute('href');
        if(!id||id==='#') return;
        var target=qs(id);
        if(target){
          e.preventDefault();
          target.scrollIntoView({behavior:'smooth',block:'start'});
          if(nav&&nav.classList.contains('open')){nav.classList.remove('open');}
        }
      });
    });

    qsa('.qty-btn').forEach(function(btn){
      btn.addEventListener('click',function(){
        var input=qs('#adet');
        if(!input)return;
        var val=parseInt(input.value||'1',10);
        if(btn.dataset.qty==='plus'){input.value=val+1;}
        else{input.value=Math.max(1,val-1);}    
      });
    });

    qsa('form[data-formsubmit]').forEach(function(form){
      form.addEventListener('submit',function(e){
        var honey=qs('input[name="_honey"]',form);
        if(honey&&honey.value.trim()!==''){e.preventDefault();return;}

        var required=[
          {id:'modelLink',msg:'Lütfen MakerWorld model linki girin.'},
          {id:'adet',msg:'Lütfen adet bilgisi girin.'},
          {id:'isim',msg:'Lütfen isminizi girin.'},
          {id:'telefon',msg:'Lütfen telefon numaranızı girin.'}
        ];

        for(var i=0;i<required.length;i++){
          var field=qs('#'+required[i].id,form);
          if(field&&!String(field.value||'').trim()){
            e.preventDefault();
            field.setCustomValidity(required[i].msg);
            field.reportValidity();
            return;
          }
          if(field){field.setCustomValidity('');}
        }

        if(!form.checkValidity()){
          e.preventDefault();
          form.reportValidity();
        }
      });
    });

    var slider=qs('#work-slider');
    if(slider){
      var next=qs('[data-slider="next"]');
      var prev=qs('[data-slider="prev"]');
      var offset=function(){return Math.min(slider.clientWidth*0.85,360);};
      if(next){next.addEventListener('click',function(){slider.scrollBy({left:offset(),behavior:'smooth'});});}
      if(prev){prev.addEventListener('click',function(){slider.scrollBy({left:-offset(),behavior:'smooth'});});}
    }

    var products=window.MINIFAB_PRODUCTS||null;
    var productsGrid=qs('#products-grid');
    if(products&&productsGrid){
      productsGrid.innerHTML=products.map(function(p){
        var teklif='teklif.html?model='+encodeURIComponent(p.title)+'&link='+encodeURIComponent(p.link);
        return '<article class="card product-card generated-card" data-category="'+escHtml(p.category)+'">'+
          (p.popular?'<span class="pop-badge">Popüler</span>':'')+
          '<a class="card-main-link" href="'+escHtml(p.link)+'" target="_blank" rel="noopener noreferrer">'+
          '<img class="topic-thumb" src="'+escHtml(p.img)+'" width="700" height="420" loading="lazy" decoding="async" alt="'+escHtml(p.title)+' 3D baskı örneği" />'+
          '<h2>'+escHtml(p.title)+'</h2></a>'+
          '<p>'+escHtml(p.description)+'</p>'+
          '<div class="meta-row"><span class="tag">'+escHtml(p.material)+'</span><span class="tag">'+escHtml(p.time)+'</span><span class="tag">'+escHtml(p.category)+'</span></div>'+
          '<a class="btn btn-secondary" href="'+escHtml(p.link)+'" target="_blank" rel="noopener noreferrer">MakerWorld\'de aç</a>'+
          '<a class="btn btn-primary" href="'+teklif+'">Bunu Bastır (Teklif Al)</a>'+
          '</article>';
      }).join('');

      qsa('.generated-card').forEach(function(card){
        card.addEventListener('click',function(e){
          if(e.target.closest('a')||e.target.closest('button')) return;
          var main=qs('.card-main-link',card);
          if(main){window.open(main.href,'_blank','noopener');}
        });
      });
    }

    var filterButtons=qsa('.filter-btn');
    if(filterButtons.length){
      filterButtons.forEach(function(btn){
        btn.addEventListener('click',function(){
          filterButtons.forEach(function(x){x.classList.remove('active')});
          btn.classList.add('active');
          var key=btn.getAttribute('data-filter');
          qsa('.product-card,.blog-card').forEach(function(card){
            var cat=card.getAttribute('data-category');
            card.style.display=(key==='all'||cat===key)?'block':'none';
          });
        });
      });
    }

    if(document.body.dataset.redirectHome==='true'){
      setTimeout(function(){window.location.href='index.html';},2000);
    }
  });
})();
