(function(){
  function qs(s,c){return (c||document).querySelector(s)}
  function qsa(s,c){return Array.from((c||document).querySelectorAll(s))}

  function escHtml(str){return String(str).replace(/[&<>'"]/g,function(m){return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];});}

  document.addEventListener('DOMContentLoaded',function(){
    var toggle=qs('.menu-toggle');
    var nav=qs('nav');
    if(toggle&&nav){
      toggle.addEventListener('click',function(){
        var open=nav.classList.toggle('open');
        toggle.setAttribute('aria-expanded',open?'true':'false');
      });
    }

    var params=new URLSearchParams(window.location.search);
    var sentBanner=qs('[data-sent-banner]');
    if(sentBanner&&params.get('sent')==='1'){sentBanner.hidden=false;}

    var modelName=params.get('model');
    var modelLink=params.get('link');
    var modelNameInput=qs('#modelAdi');
    var modelLinkInput=qs('#modelLink');
    var prefillBanner=qs('[data-prefill-banner]');
    if(modelName&&modelNameInput){modelNameInput.value=modelName;}
    if(modelLink&&modelLinkInput){modelLinkInput.value=modelLink;}
    if(prefillBanner&&(modelName||modelLink)){prefillBanner.hidden=false;}

    qsa('.qty-btn').forEach(function(btn){
      btn.addEventListener('click',function(){
        var input=qs('#adet');
        if(!input)return;
        var val=parseInt(input.value||'1',10);
        if(btn.dataset.qty==='plus'){input.value=val+1;}
        else{input.value=Math.max(1,val-1);}    
      });
    });

    qsa('form[data-formsubmit]').forEach(function(form){
      form.addEventListener('submit',function(e){
        var honey=qs('input[name="_honey"]',form);
        if(honey&&honey.value.trim()!==''){e.preventDefault();return;}

        var required=[
          {id:'adSoyad',msg:'Lütfen ad soyad girin.'},
          {id:'email',msg:'Lütfen e-posta adresi girin.'},
          {id:'modelLink',msg:'Lütfen model linkini girin.'},
          {id:'adet',msg:'Lütfen adet girin.'}
        ];

        for(var i=0;i<required.length;i++){
          var field=qs('#'+required[i].id,form);
          if(field&&!field.value.trim()){
            e.preventDefault();
            field.setCustomValidity(required[i].msg);
            field.reportValidity();
            return;
          }
          if(field){field.setCustomValidity('');}
        }

        var email=qs('#email',form);
        if(email&&!email.value.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)){
          e.preventDefault();
          email.setCustomValidity('Lütfen geçerli bir e-posta adresi girin.');
          email.reportValidity();
          return;
        }
        if(email){email.setCustomValidity('');}

        if(!form.checkValidity()){
          e.preventDefault();
          form.reportValidity();
        }
      });
    });

    var products=window.MINIFAB_PRODUCTS||null;
    var productsGrid=qs('#products-grid');
    if(products&&productsGrid){
      productsGrid.innerHTML=products.map(function(p){
        var teklif='teklif.html?model='+encodeURIComponent(p.title)+'&link='+encodeURIComponent(p.link);
        return '<article class="card product-card generated-card" data-category="'+escHtml(p.category)+'">'+
          (p.popular?'<span class="pop-badge">Popüler</span>':'')+
          '<a class="card-main-link" href="'+escHtml(p.link)+'" target="_blank" rel="noopener noreferrer">'+
          '<img class="topic-thumb" src="'+escHtml(p.img)+'" width="700" height="420" loading="lazy" decoding="async" alt="'+escHtml(p.title)+' 3D baskı örneği" />'+
          '<h2>'+escHtml(p.title)+'</h2></a>'+
          '<p>'+escHtml(p.description)+'</p>'+
          '<div class="meta-row"><span class="tag">'+escHtml(p.material)+'</span><span class="tag">'+escHtml(p.time)+'</span><span class="tag">'+escHtml(p.category)+'</span></div>'+
          '<a class="btn btn-secondary" href="'+escHtml(p.link)+'" target="_blank" rel="noopener noreferrer">MakerWorld\'de aç</a>'+
          '<a class="btn btn-primary" href="'+teklif+'">Bunu Bastır (Teklif Al)</a>'+
          '</article>';
      }).join('');

      qsa('.generated-card').forEach(function(card){
        card.addEventListener('click',function(e){
          if(e.target.closest('a')||e.target.closest('button')) return;
          var main=qs('.card-main-link',card);
          if(main){window.open(main.href,'_blank','noopener');}
        });
      });
    }

    var filterButtons=qsa('.filter-btn');
    if(filterButtons.length){
      filterButtons.forEach(function(btn){
        btn.addEventListener('click',function(){
          filterButtons.forEach(function(x){x.classList.remove('active')});
          btn.classList.add('active');
          var key=btn.getAttribute('data-filter');
          qsa('.product-card,.blog-card').forEach(function(card){
            var cat=card.getAttribute('data-category');
            card.style.display=(key==='all'||cat===key)?'block':'none';
          });
        });
      });
    }

    if(document.body.dataset.redirectHome==='true'){
      setTimeout(function(){window.location.href='index.html';},2000);
    }
  });
})();
