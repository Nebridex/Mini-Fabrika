(function(){
  function qs(s,c){return (c||document).querySelector(s)}
  function qsa(s,c){return Array.from((c||document).querySelectorAll(s))}
  function escHtml(str){return String(str).replace(/[&<>'"]/g,function(m){return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];});}
  document.addEventListener('DOMContentLoaded',function(){
    var toggle=qs('.menu-toggle');
    var nav=qs('nav');
    if(toggle&&nav){
      toggle.addEventListener('click',function(){
        var open=nav.classList.toggle('open');
        toggle.setAttribute('aria-expanded',open?'true':'false');
      });
    }
    var params=new URLSearchParams(window.location.search);
    var sentBanner=qs('[data-sent-banner]');
    if(sentBanner&&params.get('sent')==='1'){sentBanner.hidden=false;}
    var modelName=params.get('model');
    var modelLink=params.get('link');
    var modelNameInput=qs('#modelAdi');
    var modelLinkInput=qs('#modelLink');
    var prefillBanner=qs('[data-prefill-banner]');
    if(modelName&&modelNameInput){modelNameInput.value=modelName;}
    if(modelLink&&modelLinkInput){modelLinkInput.value=modelLink;}
    if(prefillBanner&&(modelName||modelLink)){prefillBanner.hidden=false;}
    qsa('.qty-btn').forEach(function(btn){
      btn.addEventListener('click',function(){
        var input=qs('#adet');
        if(!input)return;
        var val=parseInt(input.value||'1',10);
        if(btn.dataset.qty==='plus'){input.value=val+1;}
        else{input.value=Math.max(1,val-1);}    
      });
    });
    qsa('form[data-formsubmit]').forEach(function(form){
      form.addEventListener('submit',function(e){
        var honey=qs('input[name="_honey"]',form);
        if(honey&&honey.value.trim()!==''){e.preventDefault();return;}
        var required=[
          {id:'adSoyad',msg:'Lütfen ad soyad girin.'},
          {id:'email',msg:'Lütfen e-posta adresi girin.'},
          {id:'modelLink',msg:'Lütfen model linkini girin.'},
          {id:'adet',msg:'Lütfen adet girin.'}
        ];
        for(var i=0;i<required.length;i++){
          var field=qs('#'+required[i].id,form);
          if(field&&!field.value.trim()){
            e.preventDefault();
            field.setCustomValidity(required[i].msg);
            field.reportValidity();
            return;
          }
          if(field){field.setCustomValidity('');}
        }
        var email=qs('#email',form);
        if(email&&!email.value.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)){
          e.preventDefault();
          email.setCustomValidity('Lütfen geçerli bir e-posta adresi girin.');
          email.reportValidity();
          return;
        }
        if(email){email.setCustomValidity('');}
        if(!form.checkValidity()){
          e.preventDefault();
          form.reportValidity();
        }
      });
    });
    var products=window.MINIFAB_PRODUCTS||null;
    var productsGrid=qs('#products-grid');
    if(products&&productsGrid){
      productsGrid.innerHTML=products.map(function(p){
        var teklif='teklif.html?model='+encodeURIComponent(p.title)+'&link='+encodeURIComponent(p.link);
        return '<article class="card product-card generated-card" data-category="'+escHtml(p.category)+'">'+
          (p.popular?'<span class="pop-badge">Popüler</span>':'')+
          '<a class="card-main-link" href="'+escHtml(p.link)+'" target="_blank" rel="noopener noreferrer">'+
          '<img class="topic-thumb" src="'+escHtml(p.img)+'" width="700" height="420" loading="lazy" decoding="async" alt="'+escHtml(p.title)+' 3D baskı örneği" />'+
          '<h2>'+escHtml(p.title)+'</h2></a>'+
          '<p>'+escHtml(p.description)+'</p>'+
          '<div class="meta-row"><span class="tag">'+escHtml(p.material)+'</span><span class="tag">'+escHtml(p.time)+'</span><span class="tag">'+escHtml(p.category)+'</span></div>'+
          '<a class="btn btn-secondary" href="'+escHtml(p.link)+'" target="_blank" rel="noopener noreferrer">MakerWorld\'de aç</a>'+
          '<a class="btn btn-primary" href="'+teklif+'">Bunu Bastır (Teklif Al)</a>'+
          '</article>';
      }).join('');
      qsa('.generated-card').forEach(function(card){
        card.addEventListener('click',function(e){
          if(e.target.closest('a')||e.target.closest('button')) return;
          var main=qs('.card-main-link',card);
          if(main){window.open(main.href,'_blank','noopener');}
        });
      });
    }
    var filterButtons=qsa('.filter-btn');
    if(filterButtons.length){
      filterButtons.forEach(function(btn){
        btn.addEventListener('click',function(){
          filterButtons.forEach(function(x){x.classList.remove('active')});
          btn.classList.add('active');
          var key=btn.getAttribute('data-filter');
          qsa('.product-card,.blog-card').forEach(function(card){
            var cat=card.getAttribute('data-category');
            card.style.display=(key==='all'||cat===key)?'block':'none';
          });
        });
      });
    }
    function firstField(selectors){
      for(var i=0;i<selectors.length;i++){
        var el=qs(selectors[i]);
        if(el) return el;
      }
      return null;
    }
    function setIfFound(selectors,value){
      if(value===undefined||value===null||value==='') return false;
      var el=firstField(selectors);
      if(!el) return false;
      el.value=String(value);
      return true;
    }
    function clean(v){
      return (v===undefined||v===null)?'':String(v).trim();
    }
    function getPath(obj,paths){
      for(var i=0;i<paths.length;i++){
        var parts=paths[i].split('.');
        var cur=obj;
        for(var j=0;j<parts.length;j++){
          if(!cur||cur[parts[j]]===undefined){cur=null;break;}
          cur=cur[parts[j]];
        }
        if(cur!==null&&cur!==undefined&&cur!=='') return cur;
      }
      return '';
    }
    function readQueryPayload(){
      var p=new URLSearchParams(window.location.search);
      if(!p.toString()) return null;
      if(p.get('payload')){
        try{return JSON.parse(p.get('payload'));}catch(_e){}
      }
      var out={};
      var x=p.get('x')||p.get('olcu_x');
      var y=p.get('y')||p.get('olcu_y');
      var z=p.get('z')||p.get('olcu_z');
      var gram=p.get('g')||p.get('gram');
      var sure=p.get('sure')||p.get('time');
      var sablon=p.get('tpl')||p.get('sablon')||p.get('template');
      var yazi=p.get('txt')||p.get('yazi')||p.get('text');
      if(x||y||z){out.olculer={x:x,y:y,z:z};}
      if(gram) out.gram=gram;
      if(sure) out.sure=sure;
      if(sablon) out.sablon=sablon;
      if(yazi) out.yazi=yazi;
      return Object.keys(out).length?out:null;
    }
    function fillTeklifFromPayload(payload){
      if(!payload) return;
      var olculer=payload.olculer||payload.olcu||payload.dimensions||{};
      var x=getPath(payload,['x','olcuX','olcu_x','size.x','dimensions.x'])||olculer.x;
      var y=getPath(payload,['y','olcuY','olcu_y','size.y','dimensions.y'])||olculer.y;
      var z=getPath(payload,['z','olcuZ','olcu_z','size.z','dimensions.z'])||olculer.z;
      var gram=getPath(payload,['gram','tahminiGram','estimate.gram','estimate.weight']);
      var sure=getPath(payload,['sure','tahminiSure','estimate.sure','estimate.time']);
      var sablon=getPath(payload,['sablonAdi','sablon','templateName','template']);
      var yazi=getPath(payload,['yazi','text','yaziIcerigi','customText']);
      var adet=getPath(payload,['adet','quantity','istek.adet']);
      var malzeme=getPath(payload,['malzeme','material','istek.malzeme']);
      var renk=getPath(payload,['renk','color','istek.renk']);
      var notlar=getPath(payload,['not','note','notes','istek.not']);
      var ad=getPath(payload,['ad','name','kisi.ad','person.name']);
      var tel=getPath(payload,['tel','phone','kisi.tel','person.phone']);
      var mail=getPath(payload,['mail','email','kisi.mail','person.email']);
      setIfFound(['#fullName','[name="full_name"]','[name="ad"]','#adSoyad'],ad);
      setIfFound(['#phone','[name="phone"]','[name="telefon"]','#tel'],tel);
      setIfFound(['#email','[name="email"]','[name="mail"]'],mail);
      setIfFound(['#quantity','[name="quantity"]','#adet','[name="adet"]'],adet);
      setIfFound(['#material','[name="material"]','#malzeme','[name="malzeme"]'],malzeme);
      var notes=[];
      if(clean(x)||clean(y)||clean(z)) notes.push('Ölçüler (mm): '+clean(x)+' x '+clean(y)+' x '+clean(z));
      if(clean(gram)) notes.push('Tahmini Gram: '+clean(gram));
      if(clean(sure)) notes.push('Tahmini Süre: '+clean(sure));
      if(clean(sablon)) notes.push('Şablon Adı: '+clean(sablon));
      if(clean(yazi)) notes.push('Yazı: '+clean(yazi));
      if(clean(renk)) notes.push('Renk: '+clean(renk));
      if(clean(notlar)) notes.push('Not: '+clean(notlar));
      var noteField=firstField(['#notes','[name="notes"]','[name="not"]','#aciklama']);
      if(noteField&&notes.length){
        noteField.value=(noteField.value?noteField.value+'\n':'')+notes.join('\n');
      }
      var banner=qs('[data-design-prefill-banner]');
      if(banner) banner.hidden=false;
    }
    if(window.location.pathname.indexOf('teklif')!==-1){
      var payload=null;
      var raw=localStorage.getItem('mf_teklif_payload');
      if(raw){
        try{payload=JSON.parse(raw);}catch(_e){payload=null;}
      }
      if(!payload){payload=readQueryPayload();}
      fillTeklifFromPayload(payload);
      var clearBtn=qs('[data-clear-teklif]');
      if(clearBtn){
        clearBtn.addEventListener('click',function(){
          localStorage.removeItem('mf_teklif_payload');
          [
            ['#fullName','[name="full_name"]','[name="ad"]','#adSoyad'],
            ['#phone','[name="phone"]','[name="telefon"]','#tel'],
            ['#email','[name="email"]','[name="mail"]'],
            ['#quantity','[name="quantity"]','#adet','[name="adet"]'],
            ['#material','[name="material"]','#malzeme','[name="malzeme"]'],
            ['#notes','[name="notes"]','[name="not"]','#aciklama']
          ].forEach(function(group){
            var el=firstField(group);
            if(!el) return;
            if(el.tagName==='SELECT'){el.selectedIndex=0;return;}
            if(el.type==='number'){el.value='1';return;}
            el.value='';
          });
          var banner=qs('[data-design-prefill-banner]');
          if(banner) banner.hidden=true;
        });
      }
    }
    if(document.body.dataset.redirectHome==='true'){
      setTimeout(function(){window.location.href='index.html';},2000);
    }
  });
})();
